# StreamWeave development Caddy configuration
# Uses a locally-generated TLS certificate for streamweave.local.
#
# First-time setup (do once per machine):
#
#   1. Add the hostname to /etc/hosts:
#        echo '127.0.0.1 streamweave.local' | sudo tee -a /etc/hosts
#
#   2. Generate the certificate with mkcert (installs & trusts the CA automatically):
#        bash scripts/setup-dev-certs.sh
#
# See docs/getting-started/development.md for full instructions.
# The app is then available at https://streamweave.local

https://streamweave.local {
	tls /etc/caddy/certs/streamweave.local.crt /etc/caddy/certs/streamweave.local.key

	# API, auth, and user management routes → FastAPI backend
	handle /api/* {
		reverse_proxy api:8000
	}

	handle /auth/* {
		reverse_proxy api:8000
	}

	handle /users/* {
		reverse_proxy api:8000
	}

	handle /health {
		reverse_proxy api:8000
	}

	# FastAPI interactive docs (outside /api/* prefix)
	handle /swagger* {
		reverse_proxy api:8000
	}

	handle /redoc* {
		reverse_proxy api:8000
	}

	handle /openapi.json {
		reverse_proxy api:8000
	}

	# Prefect UI — admin-only.
	# The Prefect server is configured with PREFECT_UI_SERVE_BASE=/prefect/ and
	# PREFECT_UI_API_URL=/prefect/api, so the UI HTML and assets are served at /prefect/*
	# and the browser makes API calls to /prefect/api/*.
	# Caddy must rewrite /prefect/api/* → /api/* before forwarding, because Prefect's
	# own API is always rooted at /api internally.
	handle_path /prefect/api/* {
		forward_auth api:8000 {
			uri /api/auth/check-admin
			copy_headers Authorization
		}
		rewrite * /api{uri}
		reverse_proxy prefect-server:4200
	}

	handle /prefect/* {
		forward_auth api:8000 {
			uri /api/auth/check-admin
			copy_headers Authorization
		}
		reverse_proxy prefect-server:4200
	}

	# Mailpit email catch-all UI.
	# Mailpit is started with --webroot /mail/ so it serves all assets and
	# internal API calls under that prefix — no path stripping needed here.
	handle /mail/* {
		reverse_proxy mailpit:8025
	}

	# S3-compatible dev storage (rclone serve s3).
	# Strip the /s3 prefix before forwarding so rclone sees standard S3 paths.
	# Configure clients with endpoint_url https://streamweave.local/s3.
	handle_path /s3/* {
		reverse_proxy s3-dev:9000
	}

	# Vite HMR WebSocket upgrade
	@ws {
		header Connection *Upgrade*
		header Upgrade websocket
	}
	reverse_proxy @ws frontend:3000

	# Everything else → Vite dev server (hot reload)
	handle {
		reverse_proxy frontend:3000
	}
}

# Redirect plain HTTP to HTTPS
http://streamweave.local {
	redir https://streamweave.local{uri} permanent
}
